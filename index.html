<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>☯️武術課☯️簽到系統🫸🤛</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { text-align: center; font-size: 28px; margin-bottom: 10px; }
    select, input, button { font-size: 16px; margin: 4px; padding: 4px 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 14px; }
    .signed { background: #b2f2bb; }
    .warning { color: red; font-weight: bold; white-space: pre-line; }
    .admin-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; }
    .delete-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .top-controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 4px; }
    #totalCount { font-weight: bold; margin-left: auto; }
    .pagination { margin-top: 10px; text-align: center; }
    .pagination button { padding: 4px 10px; margin: 0 5px; font-size: 14px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, doc, getDocs, getDoc,
      setDoc, deleteDoc, writeBatch, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC_LRXmhX4YmMl5Xqeoa8a26vPEFoRU0co",
      authDomain: "teamwushu-93492.firebaseapp.com",
      databaseURL: "https://teamwushu-93492-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "teamwushu-93492",
      storageBucket: "teamwushu-93492.firebasestorage.app",
      messagingSenderId: "843239603565",
      appId: "1:843239603565:web:fdb6d6c593c8ed334cee64",
      measurementId: "G-55TNPH0RKS"
    };

    // 初始化 Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements
    const yearSelect = document.getElementById("year");
    const monthSelect = document.getElementById("month");
    const tableBody = document.getElementById("tableBody");
    const studentInput = document.getElementById("studentName");
    const clearBtn = document.getElementById("clearBtn");
    const exitBtn = document.getElementById("exitBtn");
    const pageInfo = document.getElementById("pageInfo");
    const totalCountEl = document.getElementById("totalCount");
    const delCol = document.getElementById("delCol");

    // 狀態變數
    let students = [];
    let records = {};
    let creditMap = {};
    let currentPage = 1;
    const perPage = 50;
    let isAdmin = false;

    // 初始化年選單
    function initYearOptions() {
      const now = new Date();
      for (let y = now.getFullYear(); y <= now.getFullYear() + 10; y++) {
        const opt = document.createElement("option");
        opt.value = y;
        opt.textContent = y + " 年";
        yearSelect.appendChild(opt);
      }
      yearSelect.value = now.getFullYear();
    }

    // 初始化月選單
    function initMonthOptions() {
      for (let m = 1; m <= 12; m++) {
        const opt = document.createElement("option");
        opt.value = String(m).padStart(2, "0");
        opt.textContent = m + " 月";
        monthSelect.appendChild(opt);
      }
      const now = new Date();
      monthSelect.value = String(now.getMonth() + 1).padStart(2, "0");
    }

    function getSelectedKey() {
      return yearSelect.value + "-" + monthSelect.value;
    }

    // 更新表頭週日日期
    function updateHeaders() {
      const yearMonth = getSelectedKey();
      const date = new Date(yearMonth + "-01");
      const sundays = [];
      while (date.getMonth() === new Date(yearMonth + "-01").getMonth()) {
        if (date.getDay() === 0) sundays.push(date.getDate());
        date.setDate(date.getDate() + 1);
      }
      for (let i = 0; i < 5; i++) {
        const dElem = document.getElementById("d" + (i + 1));
        dElem.innerHTML = `第${i + 1}週日<br>${sundays[i] || "-"}`;
      }
    }

    // 抓取全部資料
    async function fetchAll() {
      updateHeaders();

      // 讀學生列表
      const studentSnap = await getDocs(collection(db, "students"));
      students = studentSnap.docs.map(doc => doc.id);

      // 讀繳費資訊
      creditMap = {};
      const creditSnap = await getDocs(collection(db, "credit"));
      creditSnap.forEach(doc => creditMap[doc.id] = doc.data().count);

      // 讀本月份簽到資料
      const key = getSelectedKey();
      const recordDoc = await getDoc(doc(db, "records", key));
      records[key] = recordDoc.exists() ? recordDoc.data() : {};

      renderTable();
    }

    // 新增學生
    async function addStudent() {
      const name = studentInput.value.trim();
      if (!name) {
        alert("請輸入學生姓名");
        return;
      }
      if (students.includes(name)) {
        alert("學生已存在");
        return;
      }
      if (name === "承晨語渝") {
        isAdmin = true;
        clearBtn.style.display = "inline-block";
        exitBtn.style.display = "inline-block";
        delCol.style.display = "";
        studentInput.value = "";
        renderTable();
        return;
      }
      try {
        await setDoc(doc(db, "students", name), { created: serverTimestamp() });
        studentInput.value = "";
        currentPage = 1;
        await fetchAll();
      } catch (error) {
        console.error("新增學生失敗:", error);
        alert("新增學生失敗，請稍後再試");
      }
    }

    // 切換簽到狀態
    async function toggleSign(name, week) {
      const key = getSelectedKey();
      const monthRef = doc(db, "records", key);
      const docSnap = await getDoc(monthRef);
      let data = docSnap.exists() ? docSnap.data() : {};
      if (!data[name]) data[name] = [false, false, false, false, false];
      data[name][week] = !data[name][week];
      await setDoc(monthRef, data);
      await fetchAll();
    }

    // 新增繳費
    async function addCredit(name) {
      const creditRef = doc(db, "credit", name);
      const snap = await getDoc(creditRef);
      const count = snap.exists() ? snap.data().count + 5 : 5;
      await setDoc(creditRef, { count });
      await fetchAll();
    }

    // 刪除學生
    async function deleteOne(name) {
      if (!confirm("刪除學生：" + name + "？")) return;
      await deleteDoc(doc(db, "students", name));
      await deleteDoc(doc(db, "credit", name));

      const batch = writeBatch(db);
      const allRecords = await getDocs(collection(db, "records"));
      allRecords.forEach(docSnap => {
        const data = docSnap.data();
        if (data[name]) {
          delete data[name];
          batch.set(docSnap.ref, data);
        }
      });
      await batch.commit();
      await fetchAll();
    }

    // 計算學生總簽到次數（跨月份）
    function getTotalSigned(name) {
      let total = 0;
      for (const monthKey in records) {
        if (records[monthKey]?.[name]) {
          total += records[monthKey][name].filter(v => v).length;
        }
      }
      return total;
    }

    // 渲染表格
    function renderTable() {
      updateHeaders();
      const key = getSelectedKey();
      const thisMonth = records[key] || {};
      const totalPage = Math.ceil(students.length / perPage);
      if (currentPage > totalPage) currentPage = totalPage || 1;
      const pageStudents = students.slice((currentPage - 1) * perPage, currentPage * perPage);

      pageInfo.textContent = `第 ${currentPage} / ${totalPage || 1} 頁`;
      totalCountEl.textContent = `共 ${students.length} 位學生`;
      tableBody.innerHTML = "";

      pageStudents.forEach((name, idx) => {
        const row = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.textContent = `${(currentPage - 1) * perPage + idx + 1}. ${name}`;
        row.appendChild(tdName);

        for (let i = 0; i < 5; i++) {
          const td = document.createElement("td");
          const btn = document.createElement("button");
          const signedIn = thisMonth[name]?.[i];
          btn.textContent = signedIn ? "✔️" : "簽到";
          if (signedIn) btn.classList.add("signed");
          btn.onclick = () => toggleSign(name, i);
          td.appendChild(btn);
          row.appendChild(td);
        }

        const tdAdd = document.createElement("td");
        const addBtn = document.createElement("button");
        addBtn.textContent = "繳費";
        addBtn.onclick = () => addCredit(name);
        tdAdd.appendChild(addBtn);
        row.appendChild(tdAdd);

        const tdRemaining = document.createElement("td");
        const credit = creditMap[name] || 0;
        const signed = getTotalSigned(name);
        const remaining = credit - signed;
        tdRemaining.innerHTML = remaining <= 1 ? `${remaining}<br>【提醒繳費】` : remaining;
        if (remaining <= 1) tdRemaining.classList.add("warning");
        row.appendChild(tdRemaining);

        const tdTotalSigned = document.createElement("td");
        tdTotalSigned.textContent = signed;
        row.appendChild(tdTotalSigned);

        const tdDel = document.createElement("td");
        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "刪除";
          delBtn.className = "delete-btn";
          delBtn.onclick = () => deleteOne(name);
          tdDel.appendChild(delBtn);
        }
        tdDel.style.display = isAdmin ? "" : "none";
        row.appendChild(tdDel);

        tableBody.appendChild(row);
      });
    }

    // 事件綁定
    studentInput.addEventListener("keypress", e => { if (e.key === "Enter") addStudent(); });
    document.getElementById("addBtn").onclick = addStudent;
    document.getElementById("prevBtn").onclick = () => {
      if (currentPage > 1) {
        currentPage--;
        fetchAll();
      }
    };
    document.getElementById("nextBtn").onclick = () => {
      if (currentPage < Math.ceil(students.length / perPage)) {
        currentPage++;
        fetchAll();
      }
    };
    yearSelect.onchange = () => { currentPage = 1; fetchAll(); };
    monthSelect.onchange = () => { currentPage = 1; fetchAll(); };
    clearBtn.onclick = async () => {
      if (!confirm("確定要刪除所有學生資料？")) return;
      const batch = writeBatch(db);

      const studentSnap = await getDocs(collection(db, "students"));
      studentSnap.forEach(doc => batch.delete(doc.ref));

      const creditSnap = await getDocs(collection(db, "credit"));
      creditSnap.forEach(doc => batch.delete(doc.ref));

      const recordSnap = await getDocs(collection(db, "records"));
      recordSnap.forEach(doc => batch.delete(doc.ref));

      await batch.commit();
      fetchAll();
    };
    exitBtn.onclick = () => {
      isAdmin = false;
      clearBtn.style.display = "none";
      exitBtn.style.display = "none";
      delCol.style.display = "none";
      fetchAll();
    };

    // 初始化執行
    initYearOptions();
    initMonthOptions();
    fetchAll();
  </script>
</head>
<body>
  <h2>☯️武術課☯️簽到系統🫸🤛</h2>
  <div class="top-controls">
    <label for="year">選擇年份：</label>
    <select id="year"></select>
    <label for="month">選擇月份：</label>
    <select id="month"></select>
    <input type="text" id="studentName" placeholder="新增學生" />
    <button id="addBtn">新增</button>
    <button id="clearBtn" class="admin-btn" style="display:none;">全部刪除</button>
    <button id="exitBtn" class="admin-btn" style="display:none;">離開管理模式</button>
    <span id="totalCount"></span>
  </div>
  <table>
    <thead>
      <tr>
        <th>編號<br>姓名</th>
        <th id="d1">第一週日<br>-</th>
        <th id="d2">第二週日<br>-</th>
        <th id="d3">第三週日<br>-</th>
        <th id="d4">第四週日<br>-</th>
        <th id="d5">第五週日<br>-</th>
        <th>繳費<br>補堂</th>
        <th>剩餘<br>堂數</th>
        <th>累積<br>堂數</th>
        <th id="delCol" style="display:none;">刪除</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="pagination">
    <button id="prevBtn">上一頁</button>
    <span id="pageInfo">第 1 / 1 頁</span>
    <button id="nextBtn">下一頁</button>
  </div>
</body>
</html>
