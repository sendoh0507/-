<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>â˜¯ï¸æ­¦è¡“èª²ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤›</title>
  <style>
    body {
      font-family: "æ¨™æ¥·é«”", "DFKai-SB", Arial, sans-serif;
      padding: 10px;
      max-width: 900px;
      margin: auto;
      background: linear-gradient(135deg, #f0f8ff, #d0e8ff);
    }
    h2 {
      text-align: center;
      font-size: 28px;
      margin-bottom: 10px;
      color: #204060;
      text-shadow: 1px 1px 2px #aaccee;
    }
    select, input, button {
      font-size: 16px;
      margin: 4px;
      padding: 8px 14px;
      border-radius: 12px;
      border: 1.5px solid #204060;
      outline: none;
      transition: background-color 0.3s ease, color 0.3s ease;
      font-family: "æ¨™æ¥·é«”", "DFKai-SB", Arial, sans-serif;
      cursor: pointer;
    }
    select:focus, input:focus, button:focus {
      border-color: #4080c0;
      box-shadow: 0 0 5px #80aaff;
    }
    button {
      background-color: #4090ff;
      color: white;
      border: none;
      user-select: none;
    }
    button:hover {
      background-color: #3060cc;
    }
    .admin-btn {
      background-color: #e85050;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 12px;
      user-select: none;
    }
    .admin-btn:hover {
      background-color: #b03030;
    }
    .delete-btn {
      background-color: #e85050;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      user-select: none;
    }
    .delete-btn:hover {
      background-color: #b03030;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background-color: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 0 10px #aaccee;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px 6px;
      text-align: center;
      font-size: 14px;
      vertical-align: middle;
    }
    .signed {
      background: #b2f2bb;
      font-weight: bold;
    }
    .warning {
      color: red;
      font-weight: bold;
      white-space: pre-line;
    }
    .top-controls {
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: center;
      color: #204060;
    }
    #totalCount {
      font-weight: bold;
      margin-left: auto;
      color: #204060;
    }
    .pagination {
      margin-top: 10px;
      text-align: center;
    }
    .pagination button {
      padding: 8px 16px;
      margin: 0 8px;
      font-size: 14px;
      border-radius: 12px;
      background-color: #4090ff;
      color: white;
      border: none;
      cursor: pointer;
      user-select: none;
    }
    .pagination button:hover {
      background-color: #3060cc;
    }
    .adjust-btn {
      background-color: #40906e;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 3px 8px;
      margin-left: 4px;
      cursor: pointer;
      font-size: 14px;
      user-select: none;
      font-weight: bold;
      line-height: 1;
    }
    .adjust-btn:hover {
      background-color: #306048;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
</head>
<body>
  <h2>â˜¯ï¸æ­¦è¡“èª²ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤›</h2>
  <div class="top-controls">
    <label for="year">é¸æ“‡å¹´ä»½ï¼š</label>
    <select id="year"></select>
    <label for="month">é¸æ“‡æœˆä»½ï¼š</label>
    <select id="month"></select>
    <input type="text" id="studentName" placeholder="æ–°å¢å­¸ç”Ÿ" />
    <button id="addStudentBtn">æ–°å¢</button>
    <button id="clearBtn" class="admin-btn" style="display:none;">å…¨éƒ¨åˆªé™¤</button>
    <button id="exitBtn" class="admin-btn" style="display:none;">é›¢é–‹ç®¡ç†æ¨¡å¼</button>
    <span id="totalCount"></span>
  </div>
  <table>
    <thead>
      <tr>
        <th>ç·¨è™Ÿ<br>å§“å</th>
        <th id="d1">ç¬¬ä¸€é€±æ—¥<br>-</th>
        <th id="d2">ç¬¬äºŒé€±æ—¥<br>-</th>
        <th id="d3">ç¬¬ä¸‰é€±æ—¥<br>-</th>
        <th id="d4">ç¬¬å››é€±æ—¥<br>-</th>
        <th id="d5">ç¬¬äº”é€±æ—¥<br>-</th>
        <th>ç¹³è²»<br>è£œå ‚<br><small>(ç®¡ç†+/-èª¿æ•´)</small></th>
        <th>å‰©é¤˜<br>å ‚æ•¸</th>
        <th>ç´¯ç©<br>å ‚æ•¸</th>
        <th id="delCol" style="display:none;">åˆªé™¤</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="pagination">
    <button id="prevPageBtn">ä¸Šä¸€é </button>
    <span id="pageInfo">ç¬¬ 1 / 1 é </span>
    <button id="nextPageBtn">ä¸‹ä¸€é </button>
  </div>

<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyC_LRXmhX4YmMl5Xqeoa8a26vPEFoRU0co",
    authDomain: "teamwushu-93492.firebaseapp.com",
    projectId: "teamwushu-93492",
    storageBucket: "teamwushu-93492.appspot.com",
    messagingSenderId: "843239603565",
    appId: "1:843239603565:web:d79d618e03dd260f4cee64",
    measurementId: "G-40QDX4K76X"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const yearSelect = document.getElementById("year");
  const monthSelect = document.getElementById("month");
  const studentInput = document.getElementById("studentName");
  const addStudentBtn = document.getElementById("addStudentBtn");
  const clearBtn = document.getElementById("clearBtn");
  const exitBtn = document.getElementById("exitBtn");
  const tableBody = document.getElementById("tableBody");
  const totalCountEl = document.getElementById("totalCount");
  const pageInfo = document.getElementById("pageInfo");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const delCol = document.getElementById("delCol");

  let students = [];
  let records = {};
  let credits = {};
  let adjustments = {}; // æ–°å¢ï¼šå­˜æ”¾è£œå ‚èª¿æ•´
  let currentPage = 1;
  const perPage = 50;
  let isAdmin = false;

  const LS_YEAR_KEY = "lastSelectedYear";
  const LS_MONTH_KEY = "lastSelectedMonth";

  function initYearOptions() {
    const now = new Date();
    for(let y = now.getFullYear(); y <= now.getFullYear() + 10; y++) {
      let opt = document.createElement("option");
      opt.value = y;
      opt.textContent = `${y} å¹´`;
      yearSelect.appendChild(opt);
    }
    yearSelect.value = localStorage.getItem(LS_YEAR_KEY) || now.getFullYear();
  }

  function initMonthOptions() {
    for(let m=1; m<=12; m++) {
      let opt = document.createElement("option");
      opt.value = m.toString().padStart(2,"0");
      opt.textContent = `${m} æœˆ`;
      monthSelect.appendChild(opt);
    }
    monthSelect.value = localStorage.getItem(LS_MONTH_KEY) || (new Date().getMonth()+1).toString().padStart(2,"0");
  }

  yearSelect.addEventListener("change", async () => {
    localStorage.setItem(LS_YEAR_KEY, yearSelect.value);
    await loadRecords();
    renderTable();
  });

  monthSelect.addEventListener("change", async () => {
    localStorage.setItem(LS_MONTH_KEY, monthSelect.value);
    await loadRecords();
    renderTable();
  });

  function getSelectedKey() {
    return `${yearSelect.value}-${monthSelect.value}`;
  }

  function updateHeaders() {
    const date = new Date(getSelectedKey() + "-01");
    const sundays = [];
    while (date.getMonth() === new Date(getSelectedKey()).getMonth()) {
      if (date.getDay() === 0) sundays.push(date.getDate());
      date.setDate(date.getDate() + 1);
    }
    for (let i=0; i<5; i++) {
      document.getElementById("d"+(i+1)).innerHTML = `ç¬¬${i+1}é€±æ—¥<br>${sundays[i] || "-"}`;
    }
  }

  async function ensureSortOrder() {
    const snapshot = await db.collection("students").get();
    let counter = 1;
    const batch = db.batch();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data.sortOrder === undefined) {
        const ref = db.collection("students").doc(doc.id);
        batch.update(ref, { sortOrder: counter++ });
      }
    });
    if (counter > 1) await batch.commit();
  }

  async function loadStudents() {
    await ensureSortOrder();
    const snapshot = await db.collection("students").orderBy("sortOrder", "asc").get();
    students = snapshot.docs.map(doc => ({
      id: doc.id,
      name: doc.data().name,
      sortOrder: doc.data().sortOrder || 0
    }));
  }

  async function loadRecords() {
    const key = getSelectedKey();
    const doc = await db.collection("records").doc(key).get();
    records = doc.exists ? doc.data() : {};
  }

  async function loadCredits() {
    const snapshot = await db.collection("credits").get();
    credits = {};
    snapshot.forEach(doc => {
      credits[doc.id] = doc.data().value;
    });
  }

  // æ–°å¢ï¼šè®€å–è£œå ‚èª¿æ•´è³‡æ–™
  async function loadAdjustments() {
    const snapshot = await db.collection("adjustments").get();
    adjustments = {};
    snapshot.forEach(doc => {
      adjustments[doc.id] = doc.data().value || 0;
    });
  }

  async function addStudent() {
    const name = studentInput.value.trim();
    if (!name) {
      alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
      return;
    }
    if (students.find(s=>s.name===name)) {
      alert("å­¸ç”Ÿå·²å­˜åœ¨");
      return;
    }
    if (name === "æ‰¿æ™¨èªæ¸") {
      isAdmin = true;
      clearBtn.style.display = "inline-block";
      exitBtn.style.display = "inline-block";
      delCol.style.display = "";
      renderTable();
      studentInput.value = "";
      return;
    }

    const maxOrder = students.reduce((max, s) => Math.max(max, s.sortOrder || 0), 0);
    await db.collection("students").add({
      name,
      sortOrder: maxOrder + 1
    });
    studentInput.value = "";
    await loadStudents();
    renderTable();
  }

  async function toggleSign(studentId, studentName, week) {
    const key = getSelectedKey();
    if (!records[studentId]) records[studentId] = [false,false,false,false,false];
    records[studentId][week] = !records[studentId][week];
    await db.collection("records").doc(key).set(records);
    renderTable();
  }

  async function addCredit(studentId) {
    credits[studentId] = (credits[studentId] || 0) + 5;
    await db.collection("credits").doc(studentId).set({value: credits[studentId]});
    renderTable();
  }

  // æ–°å¢ï¼šèª¿æ•´è£œå ‚æ•¸ +1 æˆ– -1ï¼Œå­˜åœ¨ adjustments é›†åˆ
  async function adjustCredit(studentId, delta) {
    const oldVal = adjustments[studentId] || 0;
    const newVal = oldVal + delta;
    if (newVal < 0) {
      alert("èª¿æ•´å€¼ä¸èƒ½å°æ–¼0");
      return;
    }
    adjustments[studentId] = newVal;
    await db.collection("adjustments").doc(studentId).set({value: newVal});
    renderTable();
  }

  async function getTotalSigned(studentId) {
    let total = 0;
    const snapshot = await db.collection("records").get();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data[studentId]) {
        total += data[studentId].filter(v => v).length;
      }
    });
    return total;
  }

  async function deleteOne(studentId) {
    if (!confirm("ç¢ºå®šåˆªé™¤é€™ä½å­¸ç”Ÿï¼Ÿ")) return;
    await db.collection("students").doc(studentId).delete();
    delete credits[studentId];
    await db.collection("credits").doc(studentId).delete();
    await db.collection("adjustments").doc(studentId).delete();
    const recSnapshot = await db.collection("records").get();
    for (const doc of recSnapshot.docs) {
      const data = doc.data();
      if (data[studentId]) {
        delete data[studentId];
        await db.collection("records").doc(doc.id).set(data);
      }
    }
    students = students.filter(s=>s.id!==studentId);
    renderTable();
  }

  async function renderTable() {
    updateHeaders();
    const totalPage = Math.ceil(students.length / perPage);
    if (currentPage > totalPage) currentPage = totalPage || 1;
    pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPage || 1} é `;
    totalCountEl.textContent = `å…± ${students.length} ä½å­¸ç”Ÿ`;
    tableBody.innerHTML = "";

    const pageStudents = students.slice((currentPage-1)*perPage, currentPage*perPage);

    for (const [idx, s] of pageStudents.entries()) {
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      tdName.textContent = `${(currentPage-1)*perPage + idx + 1}. ${s.name}`;
      tr.appendChild(tdName);

      for(let i=0; i<5; i++) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        const signed = records[s.id]?.[i];
        btn.textContent = signed ? "âœ”ï¸" : "ç°½åˆ°";
        if (signed) btn.classList.add("signed");
        btn.onclick = () => toggleSign(s.id, s.name, i);
        td.appendChild(btn);
        tr.appendChild(td);
      }

      const tdCredit = document.createElement("td");
      // é¡¯ç¤ºç¹³è²»è£œå ‚æ•¸å­—
      const creditVal = credits[s.id] || 0;
      tdCredit.textContent = creditVal;

      // ç®¡ç†æ¨¡å¼ä¸‹é¡¯ç¤º +1 -1 èª¿æ•´æŒ‰éˆ•
      if (isAdmin) {
        const adjVal = adjustments[s.id] || 0;
        const adjSpan = document.createElement("span");
        adjSpan.textContent = ` (èª¿æ•´: ${adjVal})`;
        tdCredit.appendChild(adjSpan);

        const plusBtn = document.createElement("button");
        plusBtn.textContent = "+1";
        plusBtn.className = "adjust-btn";
        plusBtn.onclick = () => adjustCredit(s.id, +1);

        const minusBtn = document.createElement("button");
        minusBtn.textContent = "-1";
        minusBtn.className = "adjust-btn";
        minusBtn.onclick = () => adjustCredit(s.id, -1);

        tdCredit.appendChild(plusBtn);
        tdCredit.appendChild(minusBtn);
      } else {
        // éç®¡ç†æ¨¡å¼ä¸é¡¯ç¤ºèª¿æ•´æ•¸å€¼å’ŒæŒ‰éˆ•
      }
      tr.appendChild(tdCredit);

      const tdRemain = document.createElement("td");
      const signedCount = await getTotalSigned(s.id);

      // å‰©é¤˜å ‚æ•¸ = ç¹³è²»è£œå ‚ + èª¿æ•´ - ç°½åˆ°å ‚æ•¸
      const remain = creditVal + (adjustments[s.id] || 0) - signedCount;
      tdRemain.innerHTML = remain <= 1 ? `${remain}<br>ã€æé†’ç¹³è²»ã€‘` : remain;
      if (remain <= 1) tdRemain.classList.add("warning");
      tr.appendChild(tdRemain);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = signedCount;
      tr.appendChild(tdTotal);

      const tdDel = document.createElement("td");
      if (isAdmin) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "åˆªé™¤";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => deleteOne(s.id);
        tdDel.appendChild(delBtn);
        tdDel.style.display = "";
      } else {
        tdDel.style.display = "none";
      }
      tr.appendChild(tdDel);

      tableBody.appendChild(tr);
    }
  }

  async function clearAll() {
    if (!confirm("ç¢ºå®šåˆªé™¤æ‰€æœ‰å­¸ç”ŸåŠè³‡æ–™ï¼Ÿ")) return;
    const stuSnap = await db.collection("students").get();
    for(const doc of stuSnap.docs) await doc.ref.delete();
    const credSnap = await db.collection("credits").get();
    for(const doc of credSnap.docs) await doc.ref.delete();
    const adjSnap = await db.collection("adjustments").get();
    for(const doc of adjSnap.docs) await doc.ref.delete();
    const recSnap = await db.collection("records").get();
    for(const doc of recSnap.docs) await doc.ref.delete();
    students = [];
    records = {};
    credits = {};
    adjustments = {};
    currentPage = 1;
    renderTable();
  }

  function exitAdmin() {
    isAdmin = false;
    clearBtn.style.display = "none";
    exitBtn.style.display = "none";
    delCol.style.display = "none";
    renderTable();
  }

  prevPageBtn.onclick = () => {
    if(currentPage > 1) {
      currentPage--;
      renderTable();
    }
  };

  nextPageBtn.onclick = () => {
    const totalPage = Math.ceil(students.length / perPage);
    if(currentPage < totalPage) {
      currentPage++;
      renderTable();
    }
  };

  addStudentBtn.onclick = addStudent;
  clearBtn.onclick = clearAll;
  exitBtn.onclick = exitAdmin;

  async function init() {
    initYearOptions();
    initMonthOptions();
    await loadStudents();
    await loadCredits();
    await loadAdjustments();
    await loadRecords();
    renderTable();
  }

  init();
</script>

</body>
</html>
