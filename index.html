<script>
  // --- Firebase config ---
  const firebaseConfig = {
    apiKey: "AIzaSyC_LRXmhX4YmMl5Xqeoa8a26vPEFoRU0co",
    authDomain: "teamwushu-93492.firebaseapp.com",
    projectId: "teamwushu-93492",
    storageBucket: "teamwushu-93492.appspot.com",
    messagingSenderId: "843239603565",
    appId: "1:843239603565:web:d79d618e03dd260f4cee64",
    measurementId: "G-40QDX4K76X"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // UI Elements
  const yearSelect = document.getElementById("year");
  const monthSelect = document.getElementById("month");
  const studentInput = document.getElementById("studentName");
  const addStudentBtn = document.getElementById("addStudentBtn");
  const clearBtn = document.getElementById("clearBtn");
  const exitBtn = document.getElementById("exitBtn");
  const tableBody = document.getElementById("tableBody");
  const totalCountEl = document.getElementById("totalCount");
  const pageInfo = document.getElementById("pageInfo");
  const prevPageBtn = document.getElementById("prevPageBtn");
  const nextPageBtn = document.getElementById("nextPageBtn");
  const delCol = document.getElementById("delCol");

  // Pagination & state
  let students = [];
  let records = {};
  let credits = {};
  let currentPage = 1;
  const perPage = 50;
  let isAdmin = false;

  // 年月狀態存 localStorage key
  const LS_YEAR_KEY = "lastSelectedYear";
  const LS_MONTH_KEY = "lastSelectedMonth";

  // Year & Month dropdown init with localStorage restore
  function initYearOptions() {
    const now = new Date();
    for(let y = now.getFullYear(); y <= now.getFullYear() + 10; y++) {
      let opt = document.createElement("option");
      opt.value = y;
      opt.textContent = `${y} 年`;
      yearSelect.appendChild(opt);
    }
    // Restore year from localStorage if exists
    const savedYear = localStorage.getItem(LS_YEAR_KEY);
    yearSelect.value = savedYear ? savedYear : now.getFullYear();
  }
  function initMonthOptions() {
    for(let m=1; m<=12; m++) {
      let opt = document.createElement("option");
      opt.value = m.toString().padStart(2,"0");
      opt.textContent = `${m} 月`;
      monthSelect.appendChild(opt);
    }
    // Restore month from localStorage if exists
    const savedMonth = localStorage.getItem(LS_MONTH_KEY);
    monthSelect.value = savedMonth ? savedMonth : (new Date().getMonth()+1).toString().padStart(2,"0");
  }

  // Save year & month changes to localStorage and reload records
  yearSelect.addEventListener("change", async () => {
    localStorage.setItem(LS_YEAR_KEY, yearSelect.value);
    await loadRecords();
    renderTable();
  });
  monthSelect.addEventListener("change", async () => {
    localStorage.setItem(LS_MONTH_KEY, monthSelect.value);
    await loadRecords();
    renderTable();
  });

  function getSelectedKey() {
    return `${yearSelect.value}-${monthSelect.value}`;
  }

  function updateHeaders() {
    const date = new Date(getSelectedKey() + "-01");
    const sundays = [];
    while (date.getMonth() === new Date(getSelectedKey()).getMonth()) {
      if (date.getDay() === 0) sundays.push(date.getDate());
      date.setDate(date.getDate() + 1);
    }
    for (let i=0; i<5; i++) {
      document.getElementById("d"+(i+1)).innerHTML = `第${i+1}週日<br>${sundays[i] || "-"}`;
    }
  }

  // Load students from Firestore ordered by createdAt
  async function loadStudents() {
    const snapshot = await db.collection("students").orderBy("createdAt").get();
    students = snapshot.docs.map(doc => ({
      id: doc.id,
      name: doc.data().name,
      createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : new Date(0)
    }));
  }

  // Load attendance records for selected year-month
  async function loadRecords() {
    const key = getSelectedKey();
    const doc = await db.collection("records").doc(key).get();
    records = doc.exists ? doc.data() : {};
  }

  // Load credits
  async function loadCredits() {
    const snapshot = await db.collection("credits").get();
    credits = {};
    snapshot.forEach(doc => {
      credits[doc.id] = doc.data().value;
    });
  }

  // Add student
  async function addStudent() {
    const name = studentInput.value.trim();
    if (!name) {
      alert("請輸入學生姓名");
      return;
    }
    if (students.find(s => s.name === name)) {
      alert("學生已存在");
      return;
    }
    if (name === "承晨語渝") {
      isAdmin = true;
      clearBtn.style.display = "inline-block";
      exitBtn.style.display = "inline-block";
      delCol.style.display = "";
      renderTable();
      studentInput.value = "";
      return;
    }

    // 新增學生並帶 serverTimestamp
    const docRef = await db.collection("students").add({
      name,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // local 更新 students 陣列（createdAt 會由 firestore 回寫）
    students.push({ id: docRef.id, name, createdAt: new Date() });
    studentInput.value = "";

    // 重新讀資料確保排序正確
    await loadStudents();
    renderTable();
  }

  // Toggle attendance sign
  async function toggleSign(studentId, studentName, week) {
    const key = getSelectedKey();
    if (!records[studentId]) records[studentId] = [false,false,false,false,false];
    records[studentId][week] = !records[studentId][week];
    await db.collection("records").doc(key).set(records);
    renderTable();
  }

  // Add credit +5
  async function addCredit(studentId) {
    credits[studentId] = (credits[studentId] || 0) + 5;
    await db.collection("credits").doc(studentId).set({value: credits[studentId]});
    renderTable();
  }

  // Get total signed count across all months for studentId
  async function getTotalSigned(studentId) {
    let total = 0;
    const snapshot = await db.collection("records").get();
    snapshot.forEach(doc => {
      const data = doc.data();
      if (data[studentId]) {
        total += data[studentId].filter(v => v).length;
      }
    });
    return total;
  }

  // Delete one student
  async function deleteOne(studentId) {
    if (!confirm("確定刪除這位學生？")) return;
    await db.collection("students").doc(studentId).delete();
    delete credits[studentId];
    await db.collection("credits").doc(studentId).delete();
    const recSnapshot = await db.collection("records").get();
    for (const doc of recSnapshot.docs) {
      const data = doc.data();
      if (data[studentId]) {
        delete data[studentId];
        await db.collection("records").doc(doc.id).set(data);
      }
    }
    students = students.filter(s => s.id !== studentId);
    renderTable();
  }

  // Render table data with pagination
  async function renderTable() {
    updateHeaders();
    const totalPage = Math.ceil(students.length / perPage);
    if (currentPage > totalPage) currentPage = totalPage || 1;
    pageInfo.textContent = `第 ${currentPage} / ${totalPage || 1} 頁`;
    totalCountEl.textContent = `共 ${students.length} 位學生`;
    tableBody.innerHTML = "";

    const pageStudents = students.slice((currentPage-1)*perPage, currentPage*perPage);

    for (const [idx, s] of pageStudents.entries()) {
      const tr = document.createElement("tr");
      const tdName = document.createElement("td");
      tdName.textContent = `${(currentPage-1)*perPage + idx + 1}. ${s.name}`;
      tr.appendChild(tdName);

      for(let i=0; i<5; i++) {
        const td = document.createElement("td");
        const btn = document.createElement("button");
        const signed = records[s.id]?.[i];
        btn.textContent = signed ? "✔️" : "簽到";
        if (signed) btn.classList.add("signed");
        btn.onclick = () => toggleSign(s.id, s.name, i);
        td.appendChild(btn);
        tr.appendChild(td);
      }

      const tdCredit = document.createElement("td");
      const creditVal = credits[s.id] || 0;
      const addBtn = document.createElement("button");
      addBtn.textContent = "繳費";
      addBtn.onclick = () => addCredit(s.id);
      tdCredit.appendChild(addBtn);
      tr.appendChild(tdCredit);

      const tdRemain = document.createElement("td");
      const signedCount = await getTotalSigned(s.id);
      const remain = creditVal - signedCount;
      tdRemain.innerHTML = remain <= 1 ? `${remain}<br>【提醒繳費】` : remain;
      if (remain <= 1) tdRemain.classList.add("warning");
      tr.appendChild(tdRemain);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = signedCount;
      tr.appendChild(tdTotal);

      const tdDel = document.createElement("td");
      if (isAdmin) {
        const delBtn = document.createElement("button");
        delBtn.textContent = "刪除";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => deleteOne(s.id);
        tdDel.appendChild(delBtn);
        tdDel.style.display = "";
      } else {
        tdDel.style.display = "none";
      }
      tr.appendChild(tdDel);

      tableBody.appendChild(tr);
    }
  }

  // Clear all data (only admin)
  async function clearAll() {
    if (!confirm("確定刪除所有學生及資料？")) return;
    const stuSnap = await db.collection("students").get();
    for(const doc of stuSnap.docs) await doc.ref.delete();
    const credSnap = await db.collection("credits").get();
    for(const doc of credSnap.docs) await doc.ref.delete();
    const recSnap = await db.collection("records").get();
    for(const doc of recSnap.docs) await doc.ref.delete();
    students = [];
    records = {};
    credits = {};
    currentPage = 1;
    renderTable();
  }

  // Exit admin mode
  function exitAdmin() {
    isAdmin = false;
    clearBtn.style.display = "none";
    exitBtn.style.display = "none";
    delCol.style.display = "none";
    renderTable();
  }

  // Pagination buttons
  prevPageBtn.onclick = () => {
    if(currentPage > 1) {
      currentPage--;
      renderTable();
    }
  };
  nextPageBtn.onclick = () => {
    const totalPage = Math.ceil(students.length / perPage);
    if(currentPage < totalPage) {
      currentPage++;
      renderTable();
    }
  };

  // Event listeners for others
  addStudentBtn.onclick = addStudent;
  clearBtn.onclick = clearAll;
  exitBtn.onclick = exitAdmin;

  // Initialization
  async function init() {
    initYearOptions();
    initMonthOptions();
    await loadStudents();
    await loadCredits();
    await loadRecords();
    renderTable();
  }

  init();
</script>
