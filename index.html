<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>â˜¯ï¸æ­¦è¡“èª²â˜¯ï¸ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤›</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { text-align: center; font-size: 28px; margin-bottom: 10px; }
    select, input, button { font-size: 16px; margin: 4px; padding: 4px 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 14px; }
    .signed { background: #b2f2bb; }
    .warning { color: red; font-weight: bold; white-space: pre-line; }
    .admin-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; }
    .delete-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .top-controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 4px; }
    #totalCount { font-weight: bold; margin-left: auto; }
    .pagination { margin-top: 10px; text-align: center; }
    .pagination button { padding: 4px 10px; margin: 0 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>â˜¯ï¸æ­¦è¡“èª²â˜¯ï¸ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤›</h2>
  <div class="top-controls">
    <label for="year">é¸æ“‡å¹´ä»½ï¼š</label>
    <select id="year"></select>
    <label for="month">é¸æ“‡æœˆä»½ï¼š</label>
    <select id="month"></select>
    <input type="text" id="studentName" placeholder="æ–°å¢å­¸ç”Ÿ">
    <button onclick="addStudent()">æ–°å¢</button>
    <span id="totalCount"></span>
  </div>
  <table>
    <thead>
      <tr>
        <th>ç·¨è™Ÿ<br>å§“å</th>
        <th id="d1">ç¬¬ä¸€é€±æ—¥<br>-</th>
        <th id="d2">ç¬¬äºŒé€±æ—¥<br>-</th>
        <th id="d3">ç¬¬ä¸‰é€±æ—¥<br>-</th>
        <th id="d4">ç¬¬å››é€±æ—¥<br>-</th>
        <th id="d5">ç¬¬äº”é€±æ—¥<br>-</th>
        <th>ç°½åˆ°æ•¸</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    // âœ… Firebase åˆå§‹åŒ–ï¼ˆä½¿ç”¨ä½ çš„åƒæ•¸ï¼‰
    const firebaseConfig = {
      apiKey: "AIzaSyC_LRXmhX4YmMl5Xqeoa8a26vPEFoRU0co",
      authDomain: "teamwushu-93492.firebaseapp.com",
      projectId: "teamwushu-93492"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const yearSelect = document.getElementById("year");
    const monthSelect = document.getElementById("month");
    const tableBody = document.getElementById("tableBody");
    const studentInput = document.getElementById("studentName");
    const totalCountEl = document.getElementById("totalCount");

    let students = [];
    let records = {};
    let currentYear, currentMonth;

    function initYearMonth() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth() + 1;

      for (let i = y - 2; i <= y + 2; i++) {
        const opt = document.createElement("option");
        opt.value = i;
        opt.text = `${i} å¹´`;
        yearSelect.appendChild(opt);
      }
      for (let i = 1; i <= 12; i++) {
        const opt = document.createElement("option");
        opt.value = String(i).padStart(2, "0");
        opt.text = `${i} æœˆ`;
        monthSelect.appendChild(opt);
      }

      yearSelect.value = y;
      monthSelect.value = String(m).padStart(2, "0");

      yearSelect.onchange = reloadAll;
      monthSelect.onchange = reloadAll;

      reloadAll();
    }

    async function reloadAll() {
      currentYear = yearSelect.value;
      currentMonth = monthSelect.value;
      const key = currentYear + "-" + currentMonth;

      const studentSnap = await db.collection("students").get();
      students = studentSnap.docs.map(doc => doc.id);

      const recordDoc = await db.collection("records").doc(key).get();
      records = recordDoc.exists ? recordDoc.data() : {};

      updateHeaders();
      renderTable();
    }

    function updateHeaders() {
      const date = new Date(`${currentYear}-${currentMonth}-01`);
      const sundays = [];
      while (date.getMonth() === parseInt(currentMonth, 10) - 1) {
        if (date.getDay() === 0) sundays.push(date.getDate());
        date.setDate(date.getDate() + 1);
      }
      for (let i = 0; i < 5; i++) {
        document.getElementById("d" + (i + 1)).innerHTML = `ç¬¬${i + 1}é€±æ—¥<br>${sundays[i] || "-"}`;
      }
    }

    async function addStudent() {
      const name = studentInput.value.trim();
      if (!name || students.includes(name)) return;
      await db.collection("students").doc(name).set({ created: firebase.firestore.FieldValue.serverTimestamp() });
      studentInput.value = "";
      reloadAll();
    }

    function renderTable() {
      tableBody.innerHTML = "";
      totalCountEl.textContent = `å…± ${students.length} ä½å­¸ç”Ÿ`;
      students.forEach((name, idx) => {
        const row = document.createElement("tr");
        const tdName = document.createElement("td");
        tdName.innerHTML = `${idx + 1}. ${name}`;
        row.appendChild(tdName);

        const thisMonthRecord = records[name] || [false, false, false, false, false];
        for (let i = 0; i < 5; i++) {
          const td = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = thisMonthRecord[i] ? "âœ”ï¸" : "ç°½åˆ°";
          if (thisMonthRecord[i]) btn.classList.add("signed");
          btn.onclick = () => toggleSign(name, i);
          td.appendChild(btn);
          row.appendChild(td);
        }

        const tdCount = document.createElement("td");
        tdCount.textContent = thisMonthRecord.filter(x => x).length;
        row.appendChild(tdCount);

        tableBody.appendChild(row);
      });
    }

    async function toggleSign(name, week) {
      const key = currentYear + "-" + currentMonth;
      const ref = db.collection("records").doc(key);
      const doc = await ref.get();
      const data = doc.exists ? doc.data() : {};
      data[name] = data[name] || [false, false, false, false, false];
      data[name][week] = !data[name][week];
      await ref.set(data);
      reloadAll();
    }

    initYearMonth();
  </script>
</body>
</html>
