<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>â˜¯ï¸æ­¦è¡“èª²ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤› - Firebaseç‰ˆ</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { text-align: center; font-size: 28px; margin-bottom: 10px; }
    select, input, button { font-size: 16px; margin: 4px; padding: 4px 8px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 4px; text-align: center; font-size: 14px; }
    .signed { background: #b2f2bb; }
    .warning { color: red; font-weight: bold; white-space: pre-line; }
    .admin-btn { background-color: #f44336; color: white; border: none; padding: 6px 10px; cursor: pointer; }
    .delete-btn { background-color: #f44336; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 12px; }
    .top-controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; align-items: center; gap: 6px; }
    #totalCount { font-weight: bold; margin-left: auto; }
    .pagination { margin-top: 10px; text-align: center; }
    .pagination button { padding: 4px 10px; margin: 0 5px; font-size: 14px; }
  </style>
</head>
<body>
  <h2>â˜¯ï¸æ­¦è¡“èª²ç°½åˆ°ç³»çµ±ğŸ«¸ğŸ¤› - Firebaseç‰ˆ</h2>
  <div class="top-controls">
    <label for="year">é¸æ“‡å¹´ä»½ï¼š</label>
    <select id="year"></select>
    <label for="month">é¸æ“‡æœˆä»½ï¼š</label>
    <select id="month"></select>
    <input type="text" id="studentName" placeholder="æ–°å¢å­¸ç”Ÿ" />
    <button id="addStudentBtn">æ–°å¢</button>
    <button id="clearBtn" class="admin-btn" style="display:none;">å…¨éƒ¨åˆªé™¤</button>
    <button id="exitBtn" class="admin-btn" style="display:none;">é›¢é–‹ç®¡ç†æ¨¡å¼</button>
    <span id="totalCount"></span>
  </div>
  <table>
    <thead>
      <tr>
        <th>ç·¨è™Ÿ<br>å§“å</th>
        <th id="d1">ç¬¬ä¸€é€±æ—¥<br>-</th>
        <th id="d2">ç¬¬äºŒé€±æ—¥<br>-</th>
        <th id="d3">ç¬¬ä¸‰é€±æ—¥<br>-</th>
        <th id="d4">ç¬¬å››é€±æ—¥<br>-</th>
        <th id="d5">ç¬¬äº”é€±æ—¥<br>-</th>
        <th>ç¹³è²»<br>è£œå ‚</th>
        <th>å‰©é¤˜<br>å ‚æ•¸</th>
        <th>ç´¯ç©<br>å ‚æ•¸</th>
        <th id="delCol" style="display:none;">åˆªé™¤</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
  <div class="pagination">
    <button id="prevPageBtn">ä¸Šä¸€é </button>
    <span id="pageInfo">ç¬¬ 1 / 1 é </span>
    <button id="nextPageBtn">ä¸‹ä¸€é </button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase åˆå§‹åŒ–è¨­å®š
    const firebaseConfig = {
      apiKey: "AIzaSyC_LRXmhX4YmMl5Xqeoa8a26vPEFoRU0co",
      authDomain: "teamwushu-93492.firebaseapp.com",
      projectId: "teamwushu-93492",
      storageBucket: "teamwushu-93492.appspot.com",
      messagingSenderId: "843239603565",
      appId: "1:843239603565:web:d79d618e03dd260f4cee64",
      measurementId: "G-40QDX4K76X"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // UI å…ƒç´ 
    const yearSelect = document.getElementById("year");
    const monthSelect = document.getElementById("month");
    const studentInput = document.getElementById("studentName");
    const addStudentBtn = document.getElementById("addStudentBtn");
    const clearBtn = document.getElementById("clearBtn");
    const exitBtn = document.getElementById("exitBtn");
    const totalCountEl = document.getElementById("totalCount");
    const pageInfo = document.getElementById("pageInfo");
    const tableBody = document.getElementById("tableBody");
    const delCol = document.getElementById("delCol");
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");

    // ç‹€æ…‹
    let students = [];
    let records = {};
    let creditMap = {};
    let currentPage = 1;
    const perPage = 50;
    let isAdmin = false;

    // åˆå§‹åŒ–å¹´æœˆä»½ä¸‹æ‹‰é¸å–®
    function initYearOptions() {
      const now = new Date();
      for(let y = now.getFullYear(); y <= now.getFullYear() + 10; y++) {
        const option = document.createElement("option");
        option.value = y;
        option.textContent = y + " å¹´";
        yearSelect.appendChild(option);
      }
      yearSelect.value = new Date().getFullYear();
    }

    function initMonthOptions() {
      for(let m=1; m<=12; m++) {
        const option = document.createElement("option");
        option.value = m.toString().padStart(2,"0");
        option.textContent = m + " æœˆ";
        monthSelect.appendChild(option);
      }
      monthSelect.value = (new Date().getMonth() +1).toString().padStart(2,"0");
    }

    // è¨ˆç®—ä¸¦æ›´æ–°é€±æ—¥æ—¥æœŸæ¬„ä½
    function updateHeaders() {
      const year = yearSelect.value;
      const month = monthSelect.value;
      const date = new Date(`${year}-${month}-01`);
      const sundays = [];
      while(date.getMonth() === parseInt(month) -1) {
        if(date.getDay() === 0) sundays.push(date.getDate());
        date.setDate(date.getDate() +1);
      }
      for(let i=0; i<5; i++) {
        document.getElementById("d"+(i+1)).innerHTML = `ç¬¬${i+1}é€±æ—¥<br>${sundays[i] || "-"}`;
      }
    }

    // å–å¾—ç›®å‰é¸æ“‡çš„å¹´æœˆå­—ä¸² key (æ ¼å¼: yyyy-mm)
    function getSelectedKey() {
      return `${yearSelect.value}-${monthSelect.value}`;
    }

    // è®€å– Firestore çš„å­¸ç”Ÿæ¸…å–®ï¼ˆä¸€æ¬¡è®€å®Œï¼‰
    async function loadStudents() {
      const snapshot = await db.collection("students").orderBy("name").get();
      students = snapshot.docs.map(doc => doc.data().name);
    }

    // è®€å– Firestore çš„ç°½åˆ°ç´€éŒ„ï¼ˆä¸€æ¬¡è®€å®Œï¼‰
    async function loadRecords() {
      const snapshot = await db.collection("records").doc(getSelectedKey()).get();
      records = snapshot.exists ? snapshot.data() : {};
    }

    // è®€å– Firestore çš„ç¹³è²»è£œå ‚è³‡æ–™ï¼ˆä¸€æ¬¡è®€å®Œï¼‰
    async function loadCreditMap() {
      const snapshot = await db.collection("credits").get();
      creditMap = {};
      snapshot.forEach(doc => {
        creditMap[doc.id] = doc.data().credit || 0;
      });
    }

    // å¯«å…¥æ–°å¢å­¸ç”Ÿ
    async function addStudent() {
      const name = studentInput.value.trim();
      if(!name) return alert("è«‹è¼¸å…¥å­¸ç”Ÿå§“å");
      if(students.includes(name)) return alert("å­¸ç”Ÿå·²å­˜åœ¨");

      if(name === "æ‰¿æ™¨èªæ¸") {
        isAdmin = true;
        clearBtn.style.display = "inline-block";
        exitBtn.style.display = "inline-block";
        delCol.style.display = "";
        renderTable();
        studentInput.value = "";
        return;
      }

      // æ–°å¢å­¸ç”Ÿåˆ° Firestore students collection
      await db.collection("students").add({ name });
      studentInput.value = "";
      await loadStudents();
      await loadRecords();
      await loadCreditMap();
      currentPage = 1;
      renderTable();
    }

    // ç°½åˆ°ç‹€æ…‹åˆ‡æ›ï¼ˆæœƒæ›´æ–° Firestoreï¼‰
    async function toggleSign(name, week) {
      const key = getSelectedKey();
      const docRef = db.collection("records").doc(key);
      // ç¢ºèªç•¶æœˆç´€éŒ„
      const docSnap = await docRef.get();
      let data = docSnap.exists ? docSnap.data() : {};
      if(!data[name]) data[name] = [false,false,false,false,false];
      data[name][week] = !data[name][week];
      await docRef.set(data);
      await loadRecords();
      renderTable();
    }

    // ç¹³è²»è£œå ‚ +5
    async function addCredit(name) {
      const docRef = db.collection("credits").doc(name);
      const docSnap = await docRef.get();
      let currentCredit = docSnap.exists ? (docSnap.data().credit || 0) : 0;
      currentCredit += 5;
      await docRef.set({ credit: currentCredit });
      await loadCreditMap();
      renderTable();
    }

    // è¨ˆç®—ç´¯ç©ç°½åˆ°å ‚æ•¸
    function getTotalSigned(name) {
      let total = 0;
      for(const monthKey in records) {
        if(records[monthKey][name]) {
          total += records[monthKey][name].filter(v => v).length;
        }
      }
      return total;
    }

    // åˆªé™¤å­¸ç”ŸåŠç›¸é—œè³‡æ–™
    async function deleteOne(name) {
      if(!confirm(`åˆªé™¤å­¸ç”Ÿï¼š${name}ï¼Ÿ`)) return;
      // Firestoreæ²’æœ‰ç›´æ¥åˆªé™¤document by field nameï¼Œå…ˆæŸ¥å­¸ç”Ÿdoc id
      const studentSnap = await db.collection("students").where("name","==",name).get();
      studentSnap.forEach(doc => doc.ref.delete());

      // åˆªé™¤è©²å­¸ç”Ÿç¹³è²»è³‡æ–™
      await db.collection("credits").doc(name).delete();

      // ç´€éŒ„æ–‡ä»¶è¦æ›´æ–°ï¼šé€æœˆåˆªé™¤è©²å­¸ç”Ÿç°½åˆ°ç´€éŒ„
      const recordsDocRef = db.collection("records");
      const recordsSnap = await recordsDocRef.get();
      const batch = db.batch();
      recordsSnap.forEach(doc => {
        const data = doc.data();
        if(data[name]) {
          delete data[name];
          batch.set(doc.ref, data);
        }
      });
      await batch
      await batch.commit();
      await loadStudents();
      await loadRecords();
      await loadCreditMap();
      renderTable();
    }

    // é é¢åˆ‡æ›
    function prevPage() {
      if(currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }
    function nextPage() {
      if(currentPage < Math.ceil(students.length / perPage)) {
        currentPage++;
        renderTable();
      }
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable() {
      updateHeaders();
      const key = getSelectedKey();
      const thisMonthRecords = records[key] || {};
      const totalPage = Math.ceil(students.length / perPage) || 1;
      const pageStudents = students.slice((currentPage-1)*perPage, currentPage*perPage);
      pageInfo.textContent = `ç¬¬ ${currentPage} / ${totalPage} é `;
      totalCountEl.textContent = `å…± ${students.length} ä½å­¸ç”Ÿ`;

      tableBody.innerHTML = "";
      pageStudents.forEach((name, idx) => {
        const row = document.createElement("tr");

        // å§“åæ¬„
        const tdName = document.createElement("td");
        tdName.innerHTML = `${(currentPage-1)*perPage + idx + 1}. ${name}`;
        row.appendChild(tdName);

        // é€±æ—¥ç°½åˆ°æ¬„ (5é€±)
        for(let i=0; i<5; i++) {
          const td = document.createElement("td");
          const btn = document.createElement("button");
          const signed = thisMonthRecords[name]?.[i];
          btn.textContent = signed ? "âœ”ï¸" : "ç°½åˆ°";
          if(signed) btn.classList.add("signed");
          btn.onclick = () => toggleSign(name, i);
          td.appendChild(btn);
          row.appendChild(td);
        }

        // ç¹³è²»è£œå ‚æ¬„
        const tdCredit = document.createElement("td");
        const addBtn = document.createElement("button");
        addBtn.textContent = "ç¹³è²»";
        addBtn.onclick = () => addCredit(name);
        tdCredit.appendChild(addBtn);
        row.appendChild(tdCredit);

        // å‰©é¤˜å ‚æ•¸æ¬„
        const tdRemain = document.createElement("td");
        const credit = creditMap[name] || 0;
        const totalSigned = getTotalSigned(name);
        const remain = credit - totalSigned;
        tdRemain.innerHTML = remain <= 1 ? `${remain}<br>ã€æé†’ç¹³è²»ã€‘` : remain;
        if(remain <= 1) tdRemain.classList.add("warning");
        row.appendChild(tdRemain);

        // ç´¯ç©å ‚æ•¸æ¬„
        const tdTotal = document.createElement("td");
        tdTotal.textContent = totalSigned;
        row.appendChild(tdTotal);

        // åˆªé™¤æ¬„ï¼ˆç®¡ç†å“¡æ¨¡å¼ï¼‰
        const tdDel = document.createElement("td");
        if(isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "åˆªé™¤";
          delBtn.className = "delete-btn";
          delBtn.onclick = () => deleteOne(name);
          tdDel.appendChild(delBtn);
        }
        tdDel.style.display = isAdmin ? "" : "none";
        row.appendChild(tdDel);

        tableBody.appendChild(row);
      });
    }

    // ç®¡ç†æ¨¡å¼é›¢é–‹
    function exitAdmin() {
      isAdmin = false;
      clearBtn.style.display = "none";
      exitBtn.style.display = "none";
      delCol.style.display = "none";
      renderTable();
    }

    // å…¨éƒ¨åˆªé™¤ï¼ˆç®¡ç†å“¡ç”¨ï¼‰
    async function clearAll() {
      if(!confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰å­¸ç”Ÿèˆ‡ç´€éŒ„ï¼Ÿ")) return;
      // åˆªé™¤æ‰€æœ‰å­¸ç”Ÿæ–‡ä»¶
      const studentsSnap = await db.collection("students").get();
      const batch = db.batch();
      studentsSnap.forEach(doc => batch.delete(doc.ref));
      // åˆªé™¤æ‰€æœ‰ç´€éŒ„
      const recordsSnap = await db.collection("records").get();
      recordsSnap.forEach(doc => batch.delete(doc.ref));
      // åˆªé™¤æ‰€æœ‰ç¹³è²»è³‡æ–™
      const creditsSnap = await db.collection("credits").get();
      creditsSnap.forEach(doc => batch.delete(doc.ref));
      await batch.commit();

      await loadStudents();
      await loadRecords();
      await loadCreditMap();

      currentPage = 1;
      renderTable();
    }

    // ç¶å®šäº‹ä»¶
    addStudentBtn.onclick = addStudent;
    clearBtn.onclick = clearAll;
    exitBtn.onclick = exitAdmin;
    yearSelect.onchange = async () => {
      currentPage = 1;
      await loadRecords();
      renderTable();
    };
    monthSelect.onchange = async () => {
      currentPage = 1;
      await loadRecords();
      renderTable();
    };
    prevPageBtn.onclick = () => {
      prevPage();
    };
    nextPageBtn.onclick = () => {
      nextPage();
    };

    // åˆå§‹åŒ–é é¢
    async function init() {
      initYearOptions();
      initMonthOptions();
      await loadStudents();
      await loadRecords();
      await loadCreditMap();
      renderTable();
    }

    init();

  </script>
</body>
</html>
